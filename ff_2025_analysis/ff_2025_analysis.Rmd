---
title: "Untitled"
author: "Matteo Magcalas"
date: "2025-09-16"
output: html_notebook
editor_options:
  chunk_output_type: inline
---

Offense Involvement Charts for the 2025 NFL Season (WRs, RBs, TEs)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(nflreadr)
library(nflfastR)
library(dplyr)
library(ggplot2)
library(shiny)
```

```{r}
wr_weekly_2025 <- load_player_stats(seasons = 2025, stat_type = "weekly") %>%
  filter(position == "WR", season_type == "REG")


wr_clean_2025 <- wr_weekly_2025 %>%
  select(
    player_id, player_display_name, week, team, opponent_team,
    
    #receiving
    receptions, targets, receiving_yards, receiving_tds,
    receiving_fumbles_lost, receiving_yards_after_catch,
    receiving_epa, receiving_2pt_conversions, racr, target_share, 
    air_yards_share, wopr,
    
    #rushing
    carries, rushing_yards, rushing_tds, rushing_fumbles_lost,
    rushing_epa, rushing_2pt_conversions,
    
    #passing (rare)
    passing_yards, passing_tds, passing_interceptions, sack_fumbles_lost,
    passing_2pt_conversions
  )

head(wr_clean_2025)
```

```{r}
all_weeks_wr <- 1:max(wr_clean_2025$week, na.rm = TRUE)

wr_skeleton <- expand_grid(
  player_id = unique(wr_clean_2025$player_id),
  week = all_weeks_wr
)

wr_expanded <- wr_skeleton %>%
  left_join(wr_clean_2025, by = c("player_id", "week")) %>%
  group_by(player_id) %>%
  fill(player_display_name, team, opponent_team, .direction = "downup") %>%
  ungroup()

wr_final <- wr_expanded %>%
  mutate(across(where(is.numeric), ~ replace_na(.x, 0)))

wr_filtered <- wr_final %>%
  group_by(player_id, player_display_name) %>%
  filter(sum(targets, na.rm = TRUE) >= 1) %>%
  ungroup()

wr_filtered <- wr_filtered %>%
  mutate(
    ppr_points = #receiving
                 receptions * 1 + 
                 receiving_yards * 0.1 +
                 receiving_tds * 6 -
                 receiving_fumbles_lost * 2 +
                 receiving_2pt_conversions * 2 +
                 #rushing
                 rushing_yards * 0.1 +
                 rushing_tds * 6 -
                 rushing_fumbles_lost * 2 +
                 rushing_2pt_conversions +
                 #passing
                 passing_yards * 0.04 +
                 passing_tds * 4 -
                 passing_interceptions * 2 -
                 sack_fumbles_lost * 2 +
                 passing_2pt_conversions
  )
```

```{r}
wr_ui <- fluidPage(
  titlePanel("WR Trends - 2025 Season"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("selected_wr", "Select WR(s):",
                  choices = sort(unique(wr_filtered$player_display_name)),
                  selected = NULL, multiple = TRUE),
      selectInput("selected_team", "Select Team:",
                  choices = c("None", sort(unique(wr_filtered$team))),
                  selected = "None")
    ),
    
    mainPanel(
      tabsetPanel(
        tabPanel("Targets", plotOutput("targetsPlot")),
        tabPanel("Receptions", plotOutput("receptionsPlot")),
        tabPanel("Receiving Yards", plotOutput("yardsPlot")),
        tabPanel("Target Share", plotOutput("targetSharePlot")),
        tabPanel("WOPR", plotOutput("woprPlot")),
        tabPanel("EPA", plotOutput("epaPlot")),
        tabPanel("PPR Points", plotOutput("ppr_plot"))
      )
    )
  )
)

wr_server <- function(input, output) {
  
  filtered_data <- reactive({
    df <- wr_filtered
    if (input$selected_team != "None") {
      df <- df %>% filter(team == input$selected_team)
    }
    if (length(input$selected_wr) > 0) {
      df <- df %>% filter(player_display_name %in% input$selected_wr | team == input$selected_team)
    }
    df
  })
  
  output$targetsPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = targets, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Targets per Week", x = "Week", y = "Targets") +
      theme_minimal()
  })
  
  output$receptionsPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = receptions, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Receptions per Week", x = "Week", y = "Receptions") +
      theme_minimal()
  })
  
  output$yardsPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = receiving_yards, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Receiving Yards per Week", x = "Week", y = "Yards") +
      theme_minimal()
  })
  
  output$targetSharePlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = target_share, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Target Share per Week", x = "Week", y = "Target Share") +
      theme_minimal()
  })
  
  output$woprPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = wopr, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "WOPR per Week", x = "Week", y = "WOPR") +
      theme_minimal()
  })
  
  output$epaPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = rushing_epa + receiving_epa, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Total EPA per Week", x = "Week", y = "EPA") +
      theme_minimal()
  })
  
  output$ppr_plot <- renderPlot({
  ggplot(filtered_data(), aes(x = week, y = ppr_points, color = player_display_name)) +
    geom_line(size = 1) +
    geom_point() +
    labs(title = "PPR Points per Week", x = "Week", y = "PPR Points") +
    theme_minimal()
  })
}

shinyApp(ui = wr_ui, server = wr_server)
```

```{r}
rb_weekly_2025 <- load_player_stats(seasons = 2025, stat_type = "weekly") %>%
  filter(position == "RB", season_type == "REG")

rb_clean_2025 <- rb_weekly_2025 %>%
  select(
    player_id, player_display_name, week, team, opponent_team,
    
    #rushing
    carries, rushing_yards, rushing_tds, rushing_fumbles_lost,
    rushing_epa, rushing_2pt_conversions,
    
    #receiving
    receptions, targets, receiving_yards, receiving_tds,
    receiving_fumbles_lost, receiving_yards_after_catch,
    receiving_epa, receiving_2pt_conversions, racr, target_share, 
    air_yards_share, wopr,
    
    #passing (rare)
    passing_yards, passing_tds, passing_interceptions, sack_fumbles_lost,
    passing_2pt_conversions
  )

head(rb_clean_2025)
```

```{r}
all_weeks_rb <- 1:max(rb_clean_2025$week, na.rm = TRUE)

rb_skeleton <- expand_grid(
  player_id = unique(rb_clean_2025$player_id),
  week = all_weeks_rb
)

rb_expanded <- rb_skeleton %>%
  left_join(rb_clean_2025, by = c("player_id", "week")) %>%
  group_by(player_id) %>%
  fill(player_display_name, team, opponent_team, .direction = "downup") %>%
  ungroup()

rb_final <- rb_expanded %>%
  mutate(across(where(is.numeric), ~ replace_na(.x, 0)))

rb_filtered <- rb_final %>%
  group_by(player_id, player_display_name) %>%
  filter(sum(carries + targets, na.rm = TRUE) >= 1) %>%
  ungroup()

rb_filtered <- rb_filtered %>%
  mutate(all_purpose_yards = rushing_yards + receiving_yards)

rb_filtered <- rb_filtered %>%
  mutate(
    ppr_points = #receiving
                 receptions * 1 + 
                 receiving_yards * 0.1 +
                 receiving_tds * 6 -
                 receiving_fumbles_lost * 2 +
                 receiving_2pt_conversions * 2 +
                 #rushing
                 rushing_yards * 0.1 +
                 rushing_tds * 6 -
                 rushing_fumbles_lost * 2 +
                 rushing_2pt_conversions +
                 #passing
                 passing_yards * 0.04 +
                 passing_tds * 4 -
                 passing_interceptions * 2 -
                 sack_fumbles_lost * 2 +
                 passing_2pt_conversions
  )
```

```{r}
rb_ui <- fluidPage(
  titlePanel("RB Trends - 2025 Season"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("selected_rb", "Select RB(s):",
                  choices = sort(unique(rb_filtered$player_display_name)),
                  selected = NULL, multiple = TRUE),
      selectInput("rb_team", "Select Team:",
                  choices = c("None", sort(unique(rb_filtered$team))),
                  selected = "None")
    ),
    
    mainPanel(
      tabsetPanel(
        tabPanel("Carries", plotOutput("rb_carries")),
        tabPanel("Rushing Yards", plotOutput("rb_rushing_yards")),  # NEW
        tabPanel("Targets", plotOutput("rb_targets")),
        tabPanel("Receptions", plotOutput("rb_receptions")),
        tabPanel("Receiving Yards", plotOutput("rb_yards")),
        tabPanel("Opportunities", plotOutput("rb_opps")),
        tabPanel("EPA", plotOutput("rb_epa")),
        tabPanel("All-Purpose Yards", plotOutput("rb_apy")),
        tabPanel("PPR Points", plotOutput("ppr_plot"))
      )
    )
  )
)

rb_server <- function(input, output) {

  filtered_data <- reactive({
    df <- rb_filtered
    if (input$rb_team != "None") {
      df <- df %>% filter(team == input$rb_team)
    }
    if (length(input$selected_rb) > 0) {
      df <- df %>% filter(player_display_name %in% input$selected_rb | team == input$rb_team)
    }
    df
  })
  
  output$rb_carries <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = carries, color = player_display_name)) +
      geom_line(size = 1) + geom_point() +
      labs(title = "Carries per Week", x = "Week", y = "Carries") +
      theme_minimal()
  })

  output$rb_rushing_yards <- renderPlot({   # NEW
    ggplot(filtered_data(), aes(x = week, y = rushing_yards, color = player_display_name)) +
      geom_line(size = 1) + geom_point() +
      labs(title = "Rushing Yards per Week", x = "Week", y = "Rushing Yards") +
      theme_minimal()
  })

  output$rb_targets <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = targets, color = player_display_name)) +
      geom_line(size = 1) + geom_point() +
      labs(title = "Targets per Week", x = "Week", y = "Targets") +
      theme_minimal()
  })
  
  output$rb_receptions <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = receptions, color = player_display_name)) +
      geom_line(size = 1) + geom_point() +
      labs(title = "Receptions per Week", x = "Week", y = "Receptions") +
      theme_minimal()
  })
  
  output$rb_yards <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = receiving_yards, color = player_display_name)) +
      geom_line(size = 1) + geom_point() +
      labs(title = "Receiving Yards per Week", x = "Week", y = "Receiving Yards") +
      theme_minimal()
  })
  
  output$rb_opps <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = carries + targets, color = player_display_name)) +
      geom_line(size = 1) + geom_point() +
      labs(title = "Opportunities (Carries + Targets)", x = "Week", y = "Opportunities") +
      theme_minimal()
  })
  
  output$rb_epa <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = rushing_epa + receiving_epa, color = player_display_name)) +
      geom_line(size = 1) + geom_point() +
      labs(title = "Total EPA per Week", x = "Week", y = "EPA") +
      theme_minimal()
  })
  
  output$rb_apy <- renderPlot({
  ggplot(filtered_data(), aes(x = week, y = all_purpose_yards, color = player_display_name)) +
    geom_line(size = 1) +
    geom_point() +
    labs(title = "All-Purpose Yards per Week", x = "Week", y = "All-Purpose Yards") +
    theme_minimal()
  })
  
  output$ppr_plot <- renderPlot({
  ggplot(filtered_data(), aes(x = week, y = ppr_points, color = player_display_name)) +
    geom_line(size = 1) +
    geom_point() +
    labs(title = "PPR Points per Week", x = "Week", y = "PPR Points") +
    theme_minimal()
  })
}

shinyApp(ui = rb_ui, server = rb_server)
```

```{r}
te_weekly_2025 <- load_player_stats(seasons = 2025, stat_type = "weekly") %>%
  filter(position == "TE", season_type == "REG")

te_clean_2025 <- te_weekly_2025 %>%
  select(
    player_id, player_display_name, week, team, opponent_team,
    
    #receiving
    receptions, targets, receiving_yards, receiving_tds,
    receiving_fumbles_lost, receiving_yards_after_catch,
    receiving_epa, receiving_2pt_conversions, racr, target_share, 
    air_yards_share, wopr,
    
    #rushing
    carries, rushing_yards, rushing_tds, rushing_fumbles_lost,
    rushing_epa, rushing_2pt_conversions,
    
    #passing (rare)
    passing_yards, passing_tds, passing_interceptions, sack_fumbles_lost,
    passing_2pt_conversions
  )

head(te_clean_2025)
```

```{r}
all_weeks_te <- 1:max(te_clean_2025$week, na.rm = TRUE)

te_skeleton <- expand_grid(
  player_id = unique(te_clean_2025$player_id),
  week = all_weeks_te
)

te_expanded <- te_skeleton %>%
  left_join(te_clean_2025, by = c("player_id", "week")) %>%
  group_by(player_id) %>%
  fill(player_display_name, team, opponent_team, .direction = "downup") %>%
  ungroup()

te_final <- te_expanded %>%
  mutate(across(where(is.numeric), ~ replace_na(.x, 0)))

te_filtered <- te_final %>%
  group_by(player_id, player_display_name) %>%
  filter(sum(targets, na.rm = TRUE) >= 1) %>%
  ungroup()

te_filtered <- te_filtered %>%
  mutate(
    ppr_points = #receiving
                 receptions * 1 + 
                 receiving_yards * 0.1 +
                 receiving_tds * 6 -
                 receiving_fumbles_lost * 2 +
                 receiving_2pt_conversions * 2 +
                 #rushing
                 rushing_yards * 0.1 +
                 rushing_tds * 6 -
                 rushing_fumbles_lost * 2 +
                 rushing_2pt_conversions +
                 #passing
                 passing_yards * 0.04 +
                 passing_tds * 4 -
                 passing_interceptions * 2 -
                 sack_fumbles_lost * 2 +
                 passing_2pt_conversions
  )
```

```{r}
te_ui <- fluidPage(
  titlePanel("TE Trends - 2025 Season"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("selected_te", "Select TE(s):",
                  choices = sort(unique(te_filtered$player_display_name)),
                  selected = NULL, multiple = TRUE),
      selectInput("selected_team", "Select Team:",
                  choices = c("None", sort(unique(te_filtered$team))),
                  selected = "None")
    ),
    
    mainPanel(
      tabsetPanel(
        tabPanel("Targets", plotOutput("targetsPlot")),
        tabPanel("Receptions", plotOutput("receptionsPlot")),
        tabPanel("Receiving Yards", plotOutput("yardsPlot")),
        tabPanel("Target Share", plotOutput("targetSharePlot")),
        tabPanel("WOPR", plotOutput("woprPlot")),
        tabPanel("EPA", plotOutput("epaPlot")),
        tabPanel("PPR Points", plotOutput("ppr_plot"))
      )
    )
  )
)

te_server <- function(input, output) {
  
  filtered_data <- reactive({
    df <- te_filtered
    if (input$selected_team != "None") {
      df <- df %>% filter(team == input$selected_team)
    }
    if (length(input$selected_te) > 0) {
      df <- df %>% filter(player_display_name %in% input$selected_te | team == input$selected_team)
    }
    df
  })
  
  output$targetsPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = targets, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Targets per Week", x = "Week", y = "Targets") +
      theme_minimal()
  })
  
  output$receptionsPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = receptions, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Receptions per Week", x = "Week", y = "Receptions") +
      theme_minimal()
  })
  
  output$yardsPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = receiving_yards, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Receiving Yards per Week", x = "Week", y = "Yards") +
      theme_minimal()
  })
  
  output$targetSharePlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = target_share, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Target Share per Week", x = "Week", y = "Target Share") +
      theme_minimal()
  })
  
  output$woprPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = wopr, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "WOPR per Week", x = "Week", y = "WOPR") +
      theme_minimal()
  })
  
  output$epaPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = week, y = rushing_epa + receiving_epa, color = player_display_name)) +
      geom_line(size = 1) +
      geom_point() +
      labs(title = "Total EPA per Week", x = "Week", y = "EPA") +
      theme_minimal()
  })
  
  output$ppr_plot <- renderPlot({
  ggplot(filtered_data(), aes(x = week, y = ppr_points, color = player_display_name)) +
    geom_line(size = 1) +
    geom_point() +
    labs(title = "PPR Points per Week", x = "Week", y = "PPR Points") +
    theme_minimal()
  })
}

shinyApp(ui = te_ui, server = te_server)
```
